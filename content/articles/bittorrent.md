+++
date = "2020-01-12T12:00:00+03:00"
draft = false
title = "–ü–∏—à–µ–º —Å–≤–æ–π BitTorrent –∫–ª–∏–µ–Ω—Ç –Ω–∞ Go"
tags = ["golang", "torrent", "bittorrent"]
+++

![](/img/bittorrent/main.png)

–ü–µ—Ä–µ–≤–æ–¥ "[Building a BitTorrent client from the ground up in Go](https://blog.jse.li/posts/torrent/)"

tl;dr: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –º–æ–º–µ–Ω—Ç–∞ –≤–∏–∑–∏—Ç–∞ –Ω–∞ thepiratebay –∏ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º mp3 —Ñ–∞–π–ª–∞ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ? –í —ç—Ç–æ–º –ø–æ—Å—Ç–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º BitTorrent –ø—Ä–æ—Ç–æ–∫–æ–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ–±—Ä–∞–∑–∞ Debian. –ú–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥](https://github.com/veggiedefender/torrent-client/) –∏ [–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å](https://blog.jse.li/posts/torrent#putting-it-all-together) –≤—Å–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.

<!--more-->

BitTorrent —ç—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∏—Ö —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è(–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ñ–∏–ª—å–º–æ–≤ –Ω–∞ Netflix –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å—Ç—Ä–∞–Ω–∏—á–µ–∫), —É—á–∞—Å—Ç–Ω–∏–∫–∏ BitTorrent —Å–µ—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è peer'–∞–º–∏, —Å–∫–∞—á–∏–≤–∞—é—Ç —á–∞—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–∞. –¢–∞–∫–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è peer-to-peer –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º. –ú—ã —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ –Ω–∞–ø–∏—à–µ–º —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å peer'—ã –∏ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è —Å –Ω–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

![](/img/bittorrent/client-server-p2p.png)

–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ª–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª. –†–∞–∑–ª–∏—á–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞—Å—à–∏—Ä—è–ª–∏ –µ–≥–æ –∏ –¥–æ–±–∞–≤–ª—è–ª–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, —á–∞—Å—Ç–Ω—ã—Ö —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤ –∏ –Ω–æ–≤—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–∏—Å–∫–∞ peer'–æ–≤. –ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª 2001 –≥–æ–¥–∞, —á—Ç–æ–±—ã –Ω–∞—à —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –æ—Å—Ç–∞–≤–∞–ª—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º –∏ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–º –∑–∞ –æ–¥–Ω–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ.

–î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [Debian ISO](https://cdimage.debian.org/debian-cd/current/amd64/bt-cd/#indexlist) –∫–∞–∫ –ø–æ–¥–æ–ø—ã—Ç–Ω–æ–≥–æ –∫—Ä–æ–ª–∏–∫–∞. –≠—Ç–æ –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª, –Ω–æ –Ω–µ –æ–≥—Ä–æ–º–Ω—ã–π: 350–º–±.

## –ü–æ–∏—Å–∫ peer'–æ–≤

–ò —Ç–∞–∫, –Ω–∞–º –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –ø–æ–º–æ—â—å—é BitTorrent. –ù–æ —ç—Ç–æ peer-to-peer –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –ø–æ–∫–∞ –º—ã –ø–æ–Ω—è—Ç–∏—è –Ω–µ –∏–º–µ–µ–º, –≥–¥–µ –Ω–∞–π—Ç–∏ peer'–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø–µ—Ä–µ–µ–∑–¥ –≤ –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥ –∏ –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π: –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –≤ –±–∞—Ä–µ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ –∏–ª–∏ –Ω–∞ –∫–∞–∫–æ–º –Ω–∏ –±—É–¥—å –º–∏—Ç–∞–ø–µ. –≠—Ç–∞ –∏–¥–µ—è –ª–µ–∂–∏—Ç –≤ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö __—Ç—Ä–µ–∫–µ—Ä–æ–≤__, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç peer'–∞–º –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, —ç—Ç–æ –æ–±—ã—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —á–µ—Ä–µ–∑ HTTP. –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–∑ –î–µ–±–∏–∞–Ω–∞ –µ—Å—Ç—å —Ç—É—Ç [http://bttracker.debian.org:6969/](http://bttracker.debian.org:6969/)

![](/img/bittorrent/trackers.png)

–¢–∞–∫–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –ø–æ–¥–≤–µ—Ä–≥–∞—é—Ç—Å—è –Ω–∞–ø–∞–¥–∫–∞–º —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª–µ–π. –í–æ–∑–∏–æ–∂–Ω–æ, –≤—ã —á–∏—Ç–∞–ª–∏ –ø—Ä–æ —Ç—Ä–µ–∫–µ—Ä—ã TorrentSpy, Popcorn Time –∏ KickassTorrents, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã –∑–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ª–µ–≥–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–µ–≥–æ–¥–Ω—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –º–µ—Ç–æ–¥—ã –ø–æ–∏—Å–∫–∞ peer'–æ–≤ –±–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤: –æ–¥–Ω–æ—Ä–∞–Ω–≥–æ–≤—ã–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫. –ú—ã –Ω–µ –±—É–¥–µ–º —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —ç—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—ã, –Ω–æ –µ—Å–ª–∏ –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ - –ø–æ—á–∏—Ç–∞–π—Ç–µ –ø—Ä–æ  DHT, PEX –∏ –º–∞–≥–Ω–µ—Ç —Å—Å—ã–ª–∫–∏.

### –†–∞–∑–±–æ—Ä .torrent —Ñ–∞–π–ª–∞

–í .torrent —Ñ–∞–π–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ—Ä–µ –∏ –æ —Å–∞–º–æ–º —Ñ–∞–π–ª–µ, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å. –î–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –î–µ–±–∏–∞–Ω–æ–≤—Å–∫–∏–π .torrent —Ñ–∞–π–ª –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:"Debian CD from cdimage.debian.org"13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:ÔøΩÔøΩÔøΩÔøΩÔøΩPSÔøΩ^ÔøΩÔøΩ (binary blob of the hashes of each piece)ee
```

–î–∞–Ω–Ω—ã–µ –≤ .torrent —Ñ–∞–π–ª–µ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Bencode –∏ –Ω–∞–º –Ω—É–∂–Ω–æ –µ–≥–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å.

–í bencode —Ç–∞–∫–∏–µ –∂–µ —Ç–∏–ø—ã –∫–∞–∫ –≤ JSON: —Å—Ç—Ä–æ–∫–∏, —á–∏—Å–ª–∞, —Å–ø–∏—Å–∫–∏ –∏ —Å–ª–æ–≤–∞—Ä–∏. –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ bencode, –≤ –æ—Ç–∏—á–∏–∏ –æ—Ç JSON, –Ω–µ –æ—Å–æ–±–æ —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ. –ù–æ —Ç–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –æ—á–µ–Ω—å —É–¥–æ–±–µ–Ω –¥–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —á—Ç–µ–Ω–∏—è. –°—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º —É–∫–∞–∑–∞–Ω–∞ –¥–ª–∏–Ω–∞, –∏ –≤—ã–≥–ª—è–¥—è—Ç —Ç–∞–∫ `4:spam`. –ß–∏—Å–ª–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –º–∞—Ä–∫–µ—Ä–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä 7 –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ `i7e`. –°–ø–∏—Å–∫–∏ –∏ —Å–ª–æ–≤–∞—Ä–∏ –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏: `l4:spami7ee` —ç—Ç–æ `['spam', 7]`, –∞ `d4:spami7ee` –æ–∑–Ω–∞—á–∞–µ—Ç `{spam: 7}`.

–ï—Å–ª–∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à .torrent —Ñ–∞–π–ª, —Ç–æ –≤—Å–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∞–º–Ω–æ–≥–æ –ø–æ–Ω—è—Ç–Ω–µ–π:

```
d
  8:announce
    41:http://bttracker.debian.org:6969/announce
  7:comment
    35:"Debian CD from cdimage.debian.org"
  13:creation date
    i1573903810e
  4:info
    d
      6:length
        i351272960e
      4:name
        31:debian-10.2.0-amd64-netinst.iso
      12:piece length
        i262144e
      6:pieces
        26800:ÔøΩÔøΩÔøΩÔøΩÔøΩPSÔøΩ^ÔøΩÔøΩ (binary blob of the hashes of each piece)
    e
e
```

–ò–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å URL —Ç—Ä–µ–∫–µ—Ä–∞, –∏–º—è –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è(–≤ unix —Ñ–æ—Ä–º–∞—Ç–µ), —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–µ–π(piece length) –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–±–∏—Ç –Ω—É–∂–Ω—ã–π –Ω–∞–º —Ñ–∞–π–ª. –ö—Ä–æ–º–µ —ç—Ç–æ–≥–æ, –≤ —Ñ–∞–π–ª–µ –µ—Å—Ç—å –±–æ–ª—å—à–æ–π –∫—É—Å–æ–∫ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è SHA-1 —Ö—ç—à–∏ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π(pieces). –†–∞–∑–º–µ—Ä —á–∞—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–π, –Ω–æ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 256KB –∏ 1MB. –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ —Ç—ã—Å—è—á —á–∞—Å—Ç–µ–π. –ù–∞–º –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å —Å –Ω–∞—à–∏—Ö peer'–æ–≤, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ö—ç—à–∏ –ø–æ –Ω–∞—à–µ–º—É —Ç–æ—Ä—Ä–µ–Ω—Ç —Ñ–∞–π–ª—É, —Å–æ–±—Ä–∞—Ç—å —ç—Ç–∏ —á–∞—Å—Ç–∏ –≤–º–µ—Å—Ç–∏ –∏ –≥–æ—Ç–æ–≤–æ!

![](/img/bittorrent/pieces.png)

–¢–∞–∫–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞ –∏ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–µ –≤–∑–ª–æ–º–∞–ª SHA-1, —Ç–æ –º—ã –ø–æ–ª—É—á–∏–º —Ç–æ—Ç —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ–º.

–ë—ã–ª–æ –±—ã –ø—Ä–∏–∫–æ–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π bencode –ø–∞—Ä—Å–µ—Ä. –ù–æ —Ö–æ—á–µ—Ç—Å—è —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∂–Ω—ã—Ö –≤–µ—â–∞—Ö, –ø–æ—ç—Ç–æ–º—É –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä [github.com/jackpal/bencode-go](https://github.com/jackpal/bencode-go). –ê –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á—à–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å bencode —Ñ–æ—Ä–º–∞—Ç–æ–º - –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ [–ø–∞—Ä—Å–µ—Ä –æ—Ç Fredrik Lundh](https://effbot.org/zone/bencode.htm) –≤ 50 —Å—Ç—Ä–æ—á–µ–∫ –∫–æ–¥–∞.

```go
import (
    "github.com/jackpal/bencode-go"
)

type bencodeInfo struct {
    Pieces      string `bencode:"pieces"`
    PieceLength int    `bencode:"piece length"`
    Length      int    `bencode:"length"`
    Name        string `bencode:"name"`
}

type bencodeTorrent struct {
    Announce string      `bencode:"announce"`
    Info     bencodeInfo `bencode:"info"`
}

// Open parses a torrent file
func Open(r io.Reader) (*bencodeTorrent, error) {
    bto := bencodeTorrent{}
    err := bencode.Unmarshal(r, &bto)
    if err != nil {
        return nil, err
    }
    return &bto, nil
}
```

–Ø —Å—Ç–∞—Ä–∞—é—Å—å –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–ª–æ—Å–∫–∏–º–∏ –∏ –æ—Ç–¥–µ–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ—ç—Ç–æ–º—É —è —Å–¥–µ–ª–∞–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–π –¥—Ä—É–≥—É—é, –±–æ–ª–µ–µ –ø–ª–æ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `TorrentFile` –∏ –¥–æ–±–∞–≤–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –Ω–∏–º–∏.

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —è —Ä–∞–∑–±–∏–ª `pieces` (–≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Ç–æ –æ–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞) –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ö—ç—à–µ–π –ø–æ 20 –±–∞–π—Ç. –¢–∞–∫ —Å –Ω–∏–º–∏ –±—É–¥–µ—Ç –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å. –ò –≤—ã—á–∏—Å–ª–∏–ª –æ–±—â–∏–π SHA-1 —Ö—ç—à –≤—Å–µ–≥–æ bencode –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è info(–≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏–º—è, —Ä–∞–∑–º–µ—Ä –∏ —Ö—ç—à–∏ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π). –≠—Ç–æ—Ç –æ–±—â–∏–π —Ö—ç—à –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ç—Ä–µ–∫–µ—Ä–æ–º –∏ peer'–∞–º–∏. –û–± —ç—Ç–æ–º —á—É—Ç—å –ø–æ–∑–∂–µ.

![](/img/bittorrent/info-hash.png)

```go
type TorrentFile struct {
    Announce    string
    InfoHash    [20]byte
    PieceHashes [][20]byte
    PieceLength int
    Length      int
    Name        string
}

func (bto *bencodeTorrent) toTorrentFile() (*TorrentFile, error) {
    // ...
}
```

### –ü–æ–ª—É—á–∞–µ–º peer'–æ–≤ —á–∑ —Ç—Ä–µ–∫–µ—Ä

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –∏ —Ç—Ä–µ–∫–µ—Ä–µ, –¥–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á—Ç–æ–±—ã –æ–±—ä—è–≤–∏—Ç—å(announce) –æ –Ω–∞—à–µ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞–∫ peer'a –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥—Ä—É–≥–∏—Ö peer'–æ–≤. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å GET –∑–∞–ø—Ä–æ—Å –Ω–∞ `announce` URL —Ç—Ä–µ–∫–µ—Ä–∞ —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

```go
func (t *TorrentFile) buildTrackerURL(peerID [20]byte, port uint16) (string, error) {
    base, err := url.Parse(t.Announce)
    if err != nil {
        return "", err
    }
    params := url.Values{
        "info_hash":  []string{string(t.InfoHash[:])},
        "peer_id":    []string{string(peerID[:])},
        "port":       []string{strconv.Itoa(int(Port))},
        "uploaded":   []string{"0"},
        "downloaded": []string{"0"},
        "compact":    []string{"1"},
        "left":       []string{strconv.Itoa(t.Length)},
    }
    base.RawQuery = params.Encode()
    return base.String(), nil
}
```

–ß—Ç–æ —Ç—É—Ç –≤–∞–∂–Ω–æ:

* `info_hash` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º —Å–∫–∞—á–∞—Ç—å.  –≠—Ç–æ —Ö—ç—à, –∫–æ—Ç–æ—Ä—ã–π –º—ã –≤—ã—á–∏—Å–ª–∏–ª–∏ —Ä–∞–Ω—å—à–µ –ø–æ —Å–ª–æ–≤–∞—Ä—é `info`. –¢—Ä–µ–∫–µ—Ä—É –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —ç—Ç–æ—Ç —Ö—ç—à, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö peer'–æ–≤.
* `peer_id` - 20-—Ç–∏ –±–∞–π—Ç–Ω–æ–µ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –Ω–∞—Å –Ω–∞ —Ç—Ä–µ–∫–µ—Ä–µ –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö peer'–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –†–µ–∞–ª—å–Ω—ã–µ BitTorrent –∫–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤–∏–¥–∞ `-TR2940-k8hj0wgej6ch`, –≤ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –µ–µ –≤–µ—Ä—Å–∏—è. –í –Ω–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ, TR2940 —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç Transmission –≤–µ—Ä—Å–∏–∏ 2.94.

![](/img/bittorrent/info-hash-peer-id.png)

### –†–∞–∑–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç —Ç—Ä–µ–∫–µ—Ä–∞

–í –æ—Ç–≤–µ—Ç–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç bencod –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

```
d
  8:interval
    i900e
  5:peers
    252:(another long binary blob)
e
```

–ü–æ–ª–µ `interval` —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫ —á–∞—Å—Ç–æ –º—ã –º–æ–∂–µ–º –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ peer'–æ–≤. –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö(900 —Å–µ–∫—É–Ω–¥ = 15 –º–∏–Ω—É—Ç).

–ü–æ–ª–µ `peers` - —ç—Ç–æ –±–æ–ª—å—à–æ–π –∫—É—Å–æ–∫ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è IP –∞–¥—Ä–µ—Å–∞ –∫–∞–∂–¥–æ–≥–æ peer'–∞. –ï–≥–æ –Ω—É–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ 6 –±–∞–π—Ç–æ–≤. –ü–µ—Ä–≤—ã–µ 4 –±–∞–π—Ç–∞ - —ç—Ç–æ IP –∞–¥—Ä–µ—Å —É–∑–ª–∞, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –±–∞–π—Ç–∞ - –ø–æ—Ä—Ç(uint16 –≤ big-endian –∫–æ–¥–∏—Ä–æ–≤–∫–µ). Big-endian(–∏–ª–∏ —Å–µ—Ç–µ–≤–æ–π –ø–æ—Ä—è–¥–æ–∫) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ –≥—Ä—É–ø–ø—É –±–∞–π—Ç–æ–≤, –ø—Ä–æ—Å—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è—è –∏—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É —Å–ª–µ–≤–∞ –Ω–∞ –ø—Ä–∞–≤–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, –±–∞–π—Ç—ã 0x1A, 0xE1 –±—É–¥—É—Ç –∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ 0x1AE1 –∏–ª–∏ 6881 –≤ –¥–µ—Å—è—Ç–∏—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

![](/img/bittorrent/address.png)

```go
// Peer encodes connection information for a peer
type Peer struct {
    IP   net.IP
    Port uint16
}

// Unmarshal parses peer IP addresses and ports from a buffer
func Unmarshal(peersBin []byte) ([]Peer, error) {
    const peerSize = 6 // 4 for IP, 2 for port
    numPeers := len(peersBin) / peerSize
    if len(peersBin)%peerSize != 0 {
        err := fmt.Errorf("Received malformed peers")
        return nil, err
    }
    peers := make([]Peer, numPeers)
    for i := 0; i < numPeers; i++ {
        offset := i * peerSize
        peers[i].IP = net.IP(peersBin[offset : offset+4])
        peers[i].Port = binary.BigEndian.Uint16(peersBin[offset+4 : offset+6])
    }
    return peers, nil
}
```

## –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å peer'–æ–≤

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ peer'–æ–≤. –ù–∞—Å—Ç–∞–ª–æ –≤—Ä–µ–º—è —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å –Ω–∏–º–∏ –∏ –Ω–∞—á–∞—Ç—å —Å–∫–∞—á–∏–≤–∞—Ç—å —á–∞—Å—Ç–∏ —Ñ–∞–π–ª–∞. –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤. –î–ª—è –∫–∞–∂–¥–æ–≥–æ peer'–∞ –Ω—É–∂–Ω–æ:

1. –ù–∞—á–∞—Ç—å TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ c peer'–æ–º. –≠—Ç–æ –∫–∞–∫ –Ω–∞—á–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π BitTorrent —Ö–µ–Ω–¥—à–µ–π–∫. _"Hello?" "Hello."_
3. –û–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–∞—Å—Ç–µ–π —Ñ–∞–π–ª–∞. "–ú–Ω–µ –Ω—É–∂–Ω–∞ —á–∞—Å—Ç—å ‚Ññ231, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."

### –ù–∞—á–∏–Ω–∞–µ–º TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

```go
conn, err := net.DialTimeout("tcp", peer.String(), 3*time.Second)
if err != nil {
    return nil, err
}
```

–¢—É—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–∞—Ç—å –¥–æ–ª–≥–æ –Ω–∞ –ø–æ–ø—ã—Ç–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ peer'–∞–º.

### –í—ã–ø–æ–ª–Ω—è–µ–º —Ö–µ–Ω–¥—à–µ–π–∫(—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ)

–ú—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ peer'—É, –Ω–æ —Ç–µ–ø–µ—Ä—å –Ω–µ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—Å—è 

* Peer –º–æ–∂–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ BitTorrent –ø—Ä–æ—Ç–æ–∫–æ–ª—É
* –ú–æ–∂–µ—Ç –ø–æ–Ω–∏–º–∞—Ç—å –Ω–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –Ω–∏—Ö
* –ó–Ω–∞–µ—Ç –ø—Ä–æ —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º —Å–∫–∞—á–∞—Ç—å

![](/img/bittorrent/handshake.png)

–ú–æ–π —Å—Ç–∞—Ä–∏–∫ –æ—Ç–µ—Ü –∫–∞–∫-—Ç–æ —Å–∫–∞–∑–∞–ª –º–Ω–µ, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç —Ö–æ—Ä–æ—à–µ–≥–æ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è –≤ –µ–≥–æ –∫—Ä–µ–ø–∫–æ—Å—Ç—å –∏ –∑—Ä–∏—Ç–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ. –î–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ BitTorrent —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—Ä–µ—Ç–æ–≤:

1. –î–ª–∏–Ω–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –≤—Å–µ–≥–¥–∞ 19 (0x13 –≤ hex)
2. –°–∞–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è pstr, –≤—Å–µ–≥–¥–∞ `BitTorrent protocol`
3. –í–æ—Å–µ–º—å –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ - –≤—Å–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ 0.
4. –•—ç—à –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤(infohash, –∏–Ω—Ñ–æ—Ö—ç—à), –∫–æ—Ç–æ—Ä—ã–π –º—ã –≤—ã—á–∏—Å–ª–∏–ª–∏ —Ä–∞–Ω—å—à–µ.
5. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞—à–µ–≥–æ peer'–∞.

–°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ. –ù–∞—à —Ö–µ–Ω–¥—à–µ–π–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
\x13BitTorrent protocol\x00\x00\x00\x00\x00\x00\x00\x00\x86\xd4\xc8\x00\x24\xa4\x69\xbe\x4c\x50\xbc\x5a\x10\x2c\xf7\x17\x80\x31\x00\x74-TR2940-k8hj0wgej6ch
```

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ö–µ–Ω–¥—à–µ–π–∫–∞, –≤ –æ—Ç–≤–µ—Ç –æ–∂–∏–¥–∞–µ–º –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é —Å—Ç—Ä–æ–∫—É. –ò–Ω—Ñ–æ—Ö—ç—à, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø–æ–ª—É—á–∏–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ, –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—à–∏–º - —Ç–∞–∫ –º—ã –±—É–¥–µ–º –∑–Ω–∞—Ç—å —á—Ç–æ –≥–æ–≤–æ—Ä–∏–º –æ–± –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ. –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ, —Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É. –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –º–æ–∂–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å, –∞ –µ—Å–ª–∏ –æ—à–∏–±–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è, —Ç–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

–î–∞–≤–∞–π—Ç–µ —Ä–µ–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ö–µ–Ω–¥—à—ç–π–∫–∞ –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —á—Ç–µ–Ω–∏—è.

```go
// A Handshake is a special message that a peer uses to identify itself
type Handshake struct {
    Pstr     string
    InfoHash [20]byte
    PeerID   [20]byte
}

// Serialize serializes the handshake to a buffer
func (h *Handshake) Serialize() []byte {
    pstrlen := len(h.Pstr)
    bufLen := 49 + pstrlen
    buf := make([]byte, bufLen)
    buf[0] = byte(pstrlen)
    copy(buf[1:], h.Pstr)
    // Leave 8 reserved bytes
    copy(buf[1+pstrlen+8:], h.InfoHash[:])
    copy(buf[1+pstrlen+8+20:], h.PeerID[:])
    return buf
}

// Read parses a handshake from a stream
func Read(r io.Reader) (*Handshake, error) {
    // Do Serialize(), but backwards
    // ...
}
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

–ö–∞–∫ —Ç–æ–ª—å–∫–æ –º—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —Ä—É–æ–ø–æ–∂–∞—Ç–∏–µ, –º–æ–∂–µ–º –ø–æ—Å—ã–ª–∞—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è. –ù—É –Ω–µ —Å–æ–≤—Å–µ–º. –ü–æ–∫–∞ peer –Ω–µ —Å–æ–≥–ª–∞—Å–∏—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–æ –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –µ–º—É —á—Ç–æ-—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å. –°–µ–π—á—Å –º—ã —Å—á–∏—Ç–∞–µ–º—Å—è "–∑–∞–¥—É—à–µ–Ω–Ω—ã–º–∏"(`choked`) –¥–ª—è –¥—Ä—É–≥–∏—Ö peer'–æ–≤. –û–Ω–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ unchoke –∏—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã —Å–º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —É –Ω–∏—Ö –¥–∞–Ω–Ω—ã–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤—Å–µ –¥—Ä–∞–≥–∏–µ peer'—ã –Ω–∞—Å "–¥—É—à–∞—Ç".

–ö–æ–≥–¥–∞ –Ω–∞–º –ø—Ä–∏—Å—ã–ª–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ `unchoked`, –º–æ–∂–µ–º –Ω–∞—á–∏—Ç–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∑–∞ —á–∞—Å—Ç—è–º–∏ —Ñ–∞–π–ª–∞ –∏ –∂–¥–∞—Ç—å –≤ –æ—Ç–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º–∏ —á–∞—Å—Ç—è–º–∏.

![](/img/bittorrent/choke.png)

### –†–∞–∑–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

–í —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –¥–ª–∏–∞, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ –ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞. –≠—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫: 

![](/img/bittorrent/message.png)

–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏—è –¥–ª–∏–Ω—ã. –≠—Ç–æ 32-—Ö –±–∏—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≤ –≤–∏–¥–µ 4 –±–∞–π—Ç–æ–≤ –≤ big-endian –∫–æ–¥–∏—Ä–æ–≤–∫–µ. –°–ª–µ–¥—É—é—â–∏–π –±–∞–π—Ç - ID(–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä), –∫–æ—Ç–æ—Ä—ã–π –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞–∫–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –º—ã –ø–æ–ª—É—á–∏–ª–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, 2 –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è "interested". –ü—Å–æ–ª–µ–¥–Ω—è —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É.

```go
type messageID uint8

const (
    MsgChoke         messageID = 0
    MsgUnchoke       messageID = 1
    MsgInterested    messageID = 2
    MsgNotInterested messageID = 3
    MsgHave          messageID = 4
    MsgBitfield      messageID = 5
    MsgRequest       messageID = 6
    MsgPiece         messageID = 7
    MsgCancel        messageID = 8
)

// Message stores ID and payload of a message
type Message struct {
    ID      messageID
    Payload []byte
}

// Serialize serializes a message into a buffer of the form
// <length prefix><message ID><payload>
// Interprets `nil` as a keep-alive message
func (m *Message) Serialize() []byte {
    if m == nil {
        return make([]byte, 4)
    }
    length := uint32(len(m.Payload) + 1) // +1 for id
    buf := make([]byte, 4+length)
    binary.BigEndian.PutUint32(buf[0:4], length)
    buf[4] = byte(m.ID)
    copy(buf[5:], m.Payload)
    return buf
}
```

–í—ã—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–æ—Ç–æ–∫–∞ –∏ —Ä–∞–∑–±–∏—Ä–∞–µ–º –µ–≥–æ —Å–ª–µ–¥—É—è —Ñ–æ—Ä–º–∞—Ç—É. –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º 4 –ø–µ—Ä–≤—ã—Ö –±–∞–π—Ç–∞ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–∏—Ç–∏—Ä—É–µ–º –∏—Ö –∫–∞–∫ `uint32`. –≠—Ç–æ –¥–ª–∏–Ω–∞ –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—É—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ª—É—á–∞–µ–º ID(–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä) - –ø–µ—Ä–≤—ã–π –±–∞–π—Ç –∏ payload(–ø–æ–ª–µ–∑–µ–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É) - –æ—Å—Ç–∞—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è.

```go
// Read parses a message from a stream. Returns `nil` on keep-alive message
func Read(r io.Reader) (*Message, error) {
    lengthBuf := make([]byte, 4)
    _, err := io.ReadFull(r, lengthBuf)
    if err != nil {
        return nil, err
    }
    length := binary.BigEndian.Uint32(lengthBuf)

    // keep-alive message
    if length == 0 {
        return nil, nil
    }

    messageBuf := make([]byte, length)
    _, err = io.ReadFull(r, messageBuf)
    if err != nil {
        return nil, err
    }

    m := Message{
        ID:      messageID(messageBuf[0]),
        Payload: messageBuf[1:],
    }

    return &m, nil
}
```

### Bitfields

–°–∞–º—ã–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è - bitfield. –≠—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä—É—é peer'—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. Bitfield —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –º–∞—Å—Å–∏–≤ –±–∏—Ç–æ–≤. –ë–∏—Ç—ã, –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ 1, —É–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞–∫–∏–µ —á–∞—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤ –µ—Å—Ç—å —É peer'–∞. –≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∫–∞—Ä—Ç—É –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ—Ñ–µ–π–Ω–∏. –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç—ã(–≤—Å–µ –±–∏—Ç—ã 0), –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –∫–æ–≥–¥–∞ –≤—Å—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ—à—Ç–∞–º–ø–æ–≤–∞–Ω–∞(–≤—Å–µ –±–∏—Ç—ã –≤ 1).

![](/img/bittorrent/bitfield.png)

–†–∞–±–æ—Ç–∞ —Å _–±–∏—Ç–∞–º–∏_ —ç–∫–æ–Ω–æ–º–∏—á–Ω–µ–π —á–µ–º —Ä–∞–±–æ—Ç–∞ —Å _–±–∞–π—Ç–∞–º–∏_, —Ç–∞–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞–º–Ω–æ–≥–æ –∫–æ–ø–º–ø–∞–∫—Ç–Ω–µ–π. –ú—ã –º–æ–∂–µ–º –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ 8 —á–∞—Å—Ç—è—Ö –≤ –æ–¥–Ω–æ–º –±–∞–π—Ç–µ - —ç—Ç–æ —Ä–∞–∑–º–µ—Ä —Ç–∏–ø–∞ `bool`. –ù–æ —Å —Ç–∞–∫–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –Ω–µ —Ç–∞–∫ —É–¥–æ–±–Ω–æ —Ä–∞–æ—Ç–∞—Ç—å. –°–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ - –±–∞–π—Ç. –ü–æ—ç—Ç–æ–º—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏—Ç–∞–º–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏.

```go
// A Bitfield represents the pieces that a peer has
type Bitfield []byte

// HasPiece tells if a bitfield has a particular index set
func (bf Bitfield) HasPiece(index int) bool {
    byteIndex := index / 8
    offset := index % 8
    return bf[byteIndex]>>(7-offset)&1 != 0
}

// SetPiece sets a bit in the bitfield
func (bf Bitfield) SetPiece(index int) {
    byteIndex := index / 8
    offset := index % 8
    bf[byteIndex] |= 1 << (7 - offset)
}
```

## –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –≤—Å–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–∫–∞—á–∏–≤–∞—Ç—å —Ñ–∞–π–ª: —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ peer'–æ–≤ —Å —Ç—Ä–µ–∫–µ—Ä–∞, –º—ã –º–æ–∂–µ–º –æ–±—â–∞—Ç—å—Å—è —Å –Ω–∏–º–∏ –ø–æ TCP, –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è. –ù–æ –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å, —á—Ç–æ –ø—Ä–∏–¥–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ peer'–∞–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –∏ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ peer'–∞ –ø–æ–∫–∞ –º—ã —Å –Ω–∏–º–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ–º. –≠—Ç–æ –Ω–µ–ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏.

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é: –∫–∞–Ω–∞–ª—ã –∏ –æ—á–µ—Ä–µ–¥–∏

–í Go –ø—Ä–∏–Ω—è—Ç–æ [—Ä–∞–∑–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ –æ–±—â–µ–Ω–∏–µ](https://blog.golang.org/share-memory-by-communicating).

–ù–∞—Å—Ç—Ä–æ–∏–º –¥–≤–∞ –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞—à–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤: –æ–¥–Ω–∏ –¥–ª—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É peer'–∞–º–∏, –≤—Ç–æ—Ä–æ–π –¥–ª—è —Å–±–æ—Ä–∞ —Å–∫–∞—á–µ–Ω–Ω—ã—Ö —á–∞—Å—Ç–µ–π. –ö–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫–∞–Ω–∞–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏, –º—ã –∫–æ–ø–∏—Ä—É–µ–º –∏—Ö –≤ –±—É—Ñ–µ—Ä –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø–æ–ª–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

```go
// Init queues for workers to retrieve work and send results
workQueue := make(chan *pieceWork, len(t.PieceHashes))
results := make(chan *pieceResult)
for index, hash := range t.PieceHashes {
    length := t.calculatePieceSize(index)
    workQueue <- &pieceWork{index, hash, length}
}

// Start workers
for _, peer := range t.Peers {
    go t.startDownloadWorker(peer, workQueue, results)
}

// Collect results into a buffer until full
buf := make([]byte, t.Length)
donePieces := 0
for donePieces < len(t.PieceHashes) {
    res := <-results
    begin, end := t.calculateBoundsForPiece(res.index)
    copy(buf[begin:end], res.buf)
    donePieces++
}
close(workQueue)
```

–ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä—ã –≤ –≥–æ—Ä—É—Ç–∏–Ω–∞—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ peer'–∞. –í –≤–æ—Ä–∫–µ—Ä–∞—Ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ, –∞ –ø–æ—Ç–æ–º –≤–æ—Ä–∫–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ `workQueue` –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É–∫–∞–∑–∞–Ω—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω—É–∂–Ω—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏ —Å–∫–∏–¥—ã–≤–∞–µ—Ç –∏—Ö –≤ –∫–∞–Ω–∞–ª `results`.

![](/img/bittorrent/download.png)

```go
func (t *Torrent) startDownloadWorker(peer peers.Peer, workQueue chan *pieceWork, results chan *pieceResult) {
    c, err := client.New(peer, t.PeerID, t.InfoHash)
    if err != nil {
        log.Printf("Could not handshake with %s. Disconnecting\n", peer.IP)
        return
    }
    defer c.Conn.Close()
    log.Printf("Completed handshake with %s\n", peer.IP)

    c.SendUnchoke()
    c.SendInterested()

    for pw := range workQueue {
        if !c.Bitfield.HasPiece(pw.index) {
            workQueue <- pw // Put piece back on the queue
            continue
        }

        // Download the piece
        buf, err := attemptDownloadPiece(c, pw)
        if err != nil {
            log.Println("Exiting", err)
            workQueue <- pw // Put piece back on the queue
            return
        }

        err = checkIntegrity(pw, buf)
        if err != nil {
            log.Printf("Piece #%d failed integrity check\n", pw.index)
            workQueue <- pw // Put piece back on the queue
            continue
        }

        c.SendHave(pw.index)
        results <- &pieceResult{pw.index, buf}
    }
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏

–ú—ã –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ peer'–∞ –∏ –∏–∑–º–µ–Ω—è—Ç—å –µ–≥–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö  —Å–æ–æ–±—â–µ–Ω–∏–π. –î–ª—è —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–º, —Å–∫–æ–ª—å–∫–æ –º—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Å —ç—Ç–æ–≥–æ peer'–∞, —Å–∫–æ–ª—å–∫–æ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏ "–∑–∞–¥—É—à–µ–Ω—ã" –º—ã –∏–ª–∏ –Ω–µ—Ç. –î–ª—è –±–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏, —ç—Ç—É –ª–æ–≥–∏–∫—É –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –≤–∏–¥–µ –∫–æ–Ω–µ—á–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∞. –ù–æ –ø–æ–∫–∞ –Ω–∞–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±—ã—á–Ω–æ–≥–æ —Å–≤–∏—Ç—á–∞.

```go
type pieceProgress struct {
    index      int
    client     *client.Client
    buf        []byte
    downloaded int
    requested  int
    backlog    int
}

func (state *pieceProgress) readMessage() error {
    msg, err := state.client.Read() // this call blocks
    switch msg.ID {
    case message.MsgUnchoke:
        state.client.Choked = false
    case message.MsgChoke:
        state.client.Choked = true
    case message.MsgHave:
        index, err := message.ParseHave(msg)
        state.client.Bitfield.SetPiece(index)
    case message.MsgPiece:
        n, err := message.ParsePiece(state.index, state.buf, msg)
        state.downloaded += n
        state.backlog--
    }
    return nil
}
```

### –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã!

–§–∞–π–ª—ã, —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏ —Ö—ç—à–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ - –µ—â–µ –Ω–µ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è, –º–æ–∂–Ω–æ –ø–æ–π—Ç–∏ –¥–∞–ª—å—à–µ –∏ —Ä–∞–∑—é–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –Ω–∞ –±–ª–æ–∫–∏. –ë–ª–æ–∫–∏ - —ç—Ç–æ —á–∞—Å—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∏ –º—ã –º–æ–∂–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ø–æ –∏–Ω–¥–µ–∫—Å—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –≤—Ö–æ–¥–∏—Ç, —Å–º–µ—â–µ–Ω–∏—é –≤–Ω—É—Ç—Ä–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –∏ –¥–ª–∏–Ω–µ –±–ª–æ–∫–∞. –ö–æ–≥–¥–∞ –º—ã –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ peer'–∞–º, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–ª–æ–∫–∏. –û–±—ã—á–Ω–æ –±–ª–æ–∫ –∏–º–µ–µ—Ç –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è –≤ 16–∫–±. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, –¥–ª—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ 256–∫–± –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è 16 –∑–∞–ø—Ä–æ—Å–æ–≤.

Peer –¥–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –±–ª–æ–∫ —Ä–∞–∑–º–µ—Ä–æ–º –±–æ–ª—å—à–µ 16–∫–±. –ù–æ, —Å—É–¥—è –ø–æ –º–æ–µ–º—É –æ–ø—ã—Ç–∏, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±–ª–æ–∫–∏ –¥–æ 128–∫–±. –¢–µ–º –Ω–µ –º–µ–Ω–µ–µ, —è –ø–æ–ª—É—á–∏–ª –Ω–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π –ø—Ä–∏—Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –±–ª–æ–∫–∞, –ø–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.

### –ü–∞–π–ø–ª–∞–π–Ω

–°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–≤–æ–ª—å–Ω–æ –¥–æ—Ä–æ–≥–æ —Å—Ç–æ—è—Ç. –ò –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–æ–≤ –æ–¥–Ω–æ–≥–æ –∑–∞ –¥—Ä—É–≥–∏–º –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç  –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ü–æ—ç—Ç–æ–º—É –≤–∞–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ç–∞–∫, —á—Ç–æ–± –≤ –ø–æ–ª–µ—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –±—ã–ª–æ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –∫–æ–ª-–≤–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –º–æ–∂–µ—Ç –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞—à–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

![](/img/bittorrent/pipelining.png)

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ BitTorrent –∫–ª–∏–µ–Ω—Ç—ã –¥–µ—Ä–∂–∞—Ç –æ—á–µ—Ä–µ–¥—å –∏–∑ 5 –ø–∞–π–ø–ª–∞–π–Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –ú—ã —Ç–æ–∂–µ —Ç–∞–∫ –ø–æ—Å—Ç—É–ø–∏–º. –ü–æ—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–≤ —Å —ç—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º, —è –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –º–æ–∂–Ω–æ –≤ –¥–≤–∞ —Ä–∞–∑–∞ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç [–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π](https://luminarys.com/posts/writing-a-bittorrent-client.html) —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ª—É—á—à–µ–π —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–∏. –°–¥–µ–ª–∞–µ–º —ç—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∏ –æ—Å—Ç–∞–≤–∏–º —ç—Ç–æ –º–µ—Å—Ç–æ –¥–ª—è –±—É–¥—É—é—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

```go
// MaxBlockSize is the largest number of bytes a request can ask for
const MaxBlockSize = 16384

// MaxBacklog is the number of unfulfilled requests a client can have in its pipeline
const MaxBacklog = 5

func attemptDownloadPiece(c *client.Client, pw *pieceWork) ([]byte, error) {
    state := pieceProgress{
        index:  pw.index,
        client: c,
        buf:    make([]byte, pw.length),
    }

    // Setting a deadline helps get unresponsive peers unstuck.
    // 30 seconds is more than enough time to download a 262 KB piece
    c.Conn.SetDeadline(time.Now().Add(30 * time.Second))
    defer c.Conn.SetDeadline(time.Time{}) // Disable the deadline

    for state.downloaded < pw.length {
        // If unchoked, send requests until we have enough unfulfilled requests
        if !state.client.Choked {
            for state.backlog < MaxBacklog && state.requested < pw.length {
                blockSize := MaxBlockSize
                // Last block might be shorter than the typical block
                if pw.length-state.requested < blockSize {
                    blockSize = pw.length - state.requested
                }

                err := c.SendRequest(pw.index, state.requested, blockSize)
                if err != nil {
                    return nil, err
                }
                state.backlog++
                state.requested += blockSize
            }
        }

        err := state.readMessage()
        if err != nil {
            return nil, err
        }
    }

    return state.buf, nil
}
```

### main.go

–≠—Ç–æ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ. –ú—ã –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏

```go
package main

import (
    "log"
    "os"

    "github.com/veggiedefender/torrent-client/torrentfile"
)

func main() {
    inPath := os.Args[1]
    outPath := os.Args[2]

    tf, err := torrentfile.Open(inPath)
    if err != nil {
        log.Fatal(err)
    }

    err = tf.DownloadToFile(outPath)
    if err != nil {
        log.Fatal(err)
    }
}
```

<script id="asciicast-xqRSB0Jec8RN91Zt89rbb9PcL" src="https://asciinema.org/a/xqRSB0Jec8RN91Zt89rbb9PcL.js" async></script>

## –≠—Ç–æ –µ—â–µ –Ω–µ –≤—Å–µ

–î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è —Ñ–∫–ª—é—á–∏–ª —Ç–æ–ª—å–∫–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∫–æ–¥–∞. –Ø –æ–ø—É—Å—Ç–∏ –≤–µ—Å—å –∫–æ–¥ –¥–ª—è —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞, —Ç–µ—Å—Ç–æ–≤ –∏ –¥—Ä—É–≥–∏–µ —Å–∫—É—á–Ω—ã–µ —á–∞—Å—Ç–∏. –ü–æ–ª–Ω—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –≥–∏—Ç—Ö–∞–±–µ](https://github.com/veggiedefender/torrent-client).