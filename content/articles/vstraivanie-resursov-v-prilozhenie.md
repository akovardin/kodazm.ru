+++
date = "2015-11-27T01:23:01+03:00"
draft = false
title = "Встраивание ресурсов в приложение"

+++

<p>Перевод статьи "<a href="https://blog.codeship.com/embedding-assets-in-go/">Embedding Assets in Go</a>"</p>

<p>В этой статье я продемонстрирую, как можно встраивать ресурсы в само Go приложение. В частности, я покажу пример встраивания shell скрипта для chef-runner(одного из моих открытых проектов). Моя задача состоит в том, чтобы подтолкнуть вас к использованию этой замечательной технологии в ваших проектах. Кроме того, я постараюсь дать вам представлении о выборе правильных инструментов для подобных задач. Давайте начнем.</p>

<h3>Встречайте chef-runner. Быстрый способ запуска Chef Cookbooks.</h3>

<p>Самый большой плюс <a href="https://github.com/mlafeldt/chef-runner">chef-runner</a>'a -это ускорение разработки и тестирования <a href="https://www.chef.io/">Chef</a> cookbooks. Изначально я разрабатывал этот инструмент как быструю альтернативу медленной команде <code>vagrant provision</code>. С тех пор прошло много времени и теперь chef-runner может использоваться как для настройки виртуальных машин в Vagrant так и удаленных хостов, например инстансов EC2.</p>

<p>Одно из преимуществ chef-runner'a в том что он может установить Chef на машину до ее полного резервирования. Это позволяет использовать его на голых серверах без ПО, только с операционной системой. Для реализации этой возможности chef-runner использует скаченный в локальную папку <a href="https://docs.chef.io/install_omnibus.html">Omnibus installer</a>(также известный как <code>install.sh</code> скрипт), который будет скопирован на целевую машину где он должен будет установить Chef.</p>

<p>Чуть позже я решил немного изменить схему работы. Вместо скачивания скрипта из интернета будет лучше встроить его как часть исходника chef-runner'a. Это дает множество преимуществ:</p>

<ul>
<li>Простота. Код становится проще, не нужно реализовывать логику загрузки, не нужно реализовывать кеширование.</li>
<li>Прозрачность. Всегда используется тот скрипт, который вы добавили в репозиторий.</li>
<li>Скорость. Нет необходимости что-то скачивать для каждого проекта.</li>
</ul>

<p>К тому же, скачивание инсталятора было необходимо для поддержания актуальной версии, но от этого было мало пользы, так как он обновлялся очень редко.</p>

<p>chef-runner написан на Go. Я знал, что есть возможность встроить ресурсы в Go приложение и решил ознакомиться с различными вариантами и пакетами для этого. В конце концов, я решил использовать комбинацию <code>go-bindata</code> и <code>go generate</code>.</p>

<h3>Встраивание ресурсов с go-bindata</h3>

<p><a href="https://github.com/jteeuwen/go-bindata">go-bindata</a> конвертирует все текстовые или бинарные файлы в исходники Go. И это действительно замечательный инструмент для встраивания различных данных в ваше приложение. <code>go-bindata</code> можно использовать для встраивания CSS, JavaScript и изображений в ваше веб-приложение. В результате, у вас будет единственный бинарный файл, который можно просто деплоить как и любую другую Go программу.</p>

<p>Я использовал <code>go-bindata</code> для добавления Omnibus installer как ресурса к chef-runner'у в виде <a href="https://github.com/mlafeldt/chef-runner/blob/v0.9.0/chef/omnibus/omnibus.go">пакета <code>omnibus</code></a>. Все что мне нужно сделать для этого - скачать скрипт и выполнить команду <code>go-bindata</code> для генерирования Go кода. Более точно все выглядит так:</p>

<pre><code># inside $GOPATH/src/github.com/mlafeldt/chef-runner
$ cd chef/omnibus/ 
$ mkdir assets 
$ curl https://www.chef.io/chef/install.sh &gt; assets/install.sh 
$ go-bindata -pkg omnibus -o assets.go assets/
</code></pre>

<p>После этого я должен адаптировать <code>chef/omnibus/omnibus.go</code> для использования директории с ресурсами напрямую, не загружая их. Данные из ресурсов доступны через функцию <code>Asset</code>, которая определена в сгенерированном файле <a href="https://github.com/mlafeldt/chef-runner/blob/v0.9.0/chef/omnibus/assets.go">assets.go</a>. В результате код будет выглядеть вот так:</p>

<pre><code>// chef/omnibus/omnibus.go

package omnibus

type Installer struct { 
    ChefVersion string 
    SandboxPath string 
    RootPath string 
    Sudo bool 
}

func (i Installer) writeOmnibusScript() error { 
    script := path.Join(i.SandboxPath, "install.sh") 
    log.Debugf("Writing Omnibus script to %s\n", script) 
    data, err := Asset("assets/install.sh") 
    if err != nil { 
        return err 
    } 
    return ioutil.WriteFile(script, []byte(data), 0644) 
}
</code></pre>

<p>И это все что мне нужно было сделать. Я даже был удивлен, что понадобилось так мало усилий.</p>

<p>Тем не менее, есть небольшой момент, который мне не нравится в функции <code>Asset</code>, сгенерированной <code>go-bindata</code>. Дело в том, что эта функция будет отображаться в документации к пакету, что немного сбивает с толку. Один из вариантов, это хранить ресурсы в отдельном пакете.</p>

<p>Если вы хотите узнать больше о фичах <code>go-bindata</code>, то сходите и почитайте <a href="https://github.com/jteeuwen/go-bindata#readme">README</a>. Есть очень полезная возможность включить режим отладки, в котором данные будут загружены из исходного файла на диске с использованием того же API. Это удобно использовать во время разработки.</p>

<p>Еще один взаимосвязанный проект - <a href="https://github.com/elazarl/go-bindata-assetfs">go-bindata-assetfs</a>. Его можно использовать для раздачи файлов через <code>net/http</code>, которые были встроены с помощью <code>go-bindata</code> (внутри все реализованно через интерфейс <code>http.FileSystem</code>). Этот пакет может быть полезен для множества разных кейсов.</p>

<h3>go generate: используем кодогенерацию</h3>

<p>Хотя такие инструменты как go-bindata могут работать сами по себе, порой возникает необходимость интегрировать их в свой собственный бил процесс. Для этого вы можете использовать например Make, который будет работать как клей в вашей системе сборки. Но было бы намного круче, если бы Go сам предоставлял необходимые инструменты для генерации кода. И, на самом деле, так и есть!</p>

<p>В <a href="https://blog.golang.org/go1.4">Go 1.4</a> появился новый инструмент <code>go generate</code>, который позволяет автоматизировать генерацию исходного кода перед его компиляцией. Этот инструмент сканирует ваш проект на наличие специальных комментариев, которые определяют порядок генерации. Это дает возможность указывать инструкции сборки прямо в вашем коде, что делает сборку более структурированной.</p>

<p>Пример комментария, который я добавил в пакет  <code>omnibus</code>:</p>

<pre><code>// chef/omnibus/omnibus.go

package omnibus

//go:generate go-bindata -pkg $GOPACKAGE -o assets.go assets/
</code></pre>

<p>Теперь при запуске <code>go generate</code> выполниться команда <code>go-bindata</code> с указанными параметрами (<code>$GOPACKAGE</code> будет заменено на текущее имя пакета, например "omnibus"). Давайте сгенерируем немного кода:</p>

<pre><code>$ go generate -x ./chef/omnibus
go-bindata -pkg omnibus -o assets.go assets/
</code></pre>

<p>Флаг <code>-x</code> означает, что во время выполнения <code>go generate</code> будут выводится все выполняемые ею действия. И эти действия должны быть вам знакомы.</p>

<p>Как и в большинстве Go инструментов, вы можете запустить <code>go generate ./...</code> для прохода по всем пакетам в вашем проекте. И если так случилось, что у вас есть Makefile, то сейчас самое время добавить цель <code>make generate</code> для сокращения и для использования в других целях в Makefile.</p>

<p>Есть только одни неудобный момент работы с <code>go generate</code>, про котрый вы должны помнить: нет никакой интеграции с <code>go get</code>, как можно было бы ожидать. Если вы хотите, чтобы ваш проект был "go gettable", то вам нужно положить в систему контроля версий и сгенерированный файлы, как это сделал я с <a href="https://github.com/mlafeldt/chef-runner/blob/v0.9.0/chef/omnibus/assets.go">assets.go</a>.</p>

<p>Для более детальной информации по <code>go generate</code> используйте <code>go help generate</code> или, что еще лучше, <a href="http://blog.golang.org/generate">почитайте эту статью</a> в блоге Go.</p>

<h3>Заключение</h3>

<p>В целом, в Go есть удобные средства для встраивания ресурсов, которыми легко пользоваться благодаря существующим инструментам. Это и <code>go-bindata</code>, которая позволяет конвертировать любые данные в встраиваемые ресурсы, и <code>go generate</code>, который позволяет автоматизировать генерацию Go кода красивым способом. Я уверен, в недалеком будущем мы будем использовать эти инструменты еще чаще.</p>

<p>И еще кое-что. В одном из своих открытых проектах я использовал <a href="https://github.com/mlafeldt/pkgcloud/blob/master/gendistros.py">Python script</a> для генерации Go map'ы со списком дистров, поддерживаемых <a href="https://packagecloud.io/">Packagecloud</a>. Так как я генерировал эту map еще до компиляции, то на этапы исполнения у меня получилось сэкономить на API вызовах. Я рекомендую вам ознакомиться с <a href="https://github.com/mlafeldt/pkgcloud">исходным кодом проекта</a>, чтобы быть в курсе какие еще бывают практики встраивания ресурсов в свои приложения.</p>
